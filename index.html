<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; margin: 0 auto; padding: 20px; max-width: 800px; background: #f4f6f9; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin: 5px 0 15px 0;
      border: 1px solid #ccc; border-radius: 5px; font-size: 16px;
    }
    button {
      background: #4b2aad; color: white; border: none; cursor: pointer;
    }
    button:hover { background: #341c91; }
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
    .trip-card {
      background: white; border: 1px solid #ccc; border-radius: 10px;
      padding: 15px; margin-bottom: 10px;
    }
    .trip-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .popup, .ratePopup {
      display: none; position: fixed; top: 5%; left: 50%; transform: translateX(-50%);
      width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto;
      background: white; padding: 20px; border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 1000;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #4b2aad; color: white; }
    #printContent { display: none; }
    @media print {
      body * { visibility: hidden; }
      #printContent, #printContent * { visibility: visible; }
      #printContent { position: absolute; top: 0; left: 0; width: 100%; }
    }
    .invoice {
      padding: 20px; border: 2px solid #000; margin-bottom: 30px;
      background: white; page-break-after: always;
    }
    .invoice h2 {
      color: #4b2aad; border-bottom: 2px solid #000;
      padding-bottom: 5px; margin-bottom: 15px; font-size: 24px;
    }
    .invoice-table {
      width: 100%; border-collapse: collapse;
      margin-top: 10px; font-size: 16px;
    }
    .invoice-table th, .invoice-table td {
      border: 1px solid #ccc; padding: 10px; text-align: left;
    }
    .invoice-table th { background: #f0f0f0; }
    .section-title { font-weight: bold; margin-top: 20px; color: #333; }
  </style>
</head>
<body>

<h2>üìù NST Trip Sheet</h2>
<div id="mainForm">
  <!-- Form Fields -->
  <label>Trip ID</label><input id="tripId" readonly>
  <label>Date</label><input type="date" id="tripDate">
  <label>Customer Name</label><input id="custName">
  <label>Customer Number</label><input id="custNumber">
  <label>Driver Name</label><input id="driverName">
  <label>Driver Number</label><input id="driverNumber">
  <label>Vehicle Model</label>
  <select id="vehicleModel" onchange="sync(true)">
    <option value="">-- Select --</option>
    <option>Innova Crysta</option>
    <option>Innova Hycross</option>
    <option>Force Urbania</option>
  </select>
  <label>Vehicle Number</label>
  <select id="vehicleNo" onchange="sync(false)">
    <option value="">-- Select --</option>
    <option>PY05N0505</option>
    <option>PY01DB1007</option>
    <option>TN14AP2084</option>
  </select>
  <label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
  <label>End Time</label><input type="time" id="endTime" onchange="recalc()">
  <label>Duration (hrs)</label><input id="duration" readonly>
  <label>Extra Hours</label><input id="extraHours" readonly>
  <label>Start KM</label><input type="number" id="startKM" onchange="recalc()">
  <label>End KM</label><input type="number" id="endKM" onchange="recalc()">
  <label>Total KM</label><input id="totalKM" readonly>
  <label>Extra KM</label><input id="extraKM" readonly>
  <label>Package ‚Çπ</label><input id="packageCost" readonly>
  <label>Extra Hr ‚Çπ</label><input id="extraHrCost" readonly>
  <label>Extra KM ‚Çπ</label><input id="extraKmCost" readonly>
  <label>Toll ‚Çπ</label><input type="number" id="toll" value="0" onchange="recalc()">
  <label>Parking ‚Çπ</label><input type="number" id="parking" value="0" onchange="recalc()">
  <label>Total ‚Çπ</label><input id="totalCost" readonly>
  <label>Note</label><textarea id="note" rows="3" placeholder="Enter notes..."></textarea>
  <input type="hidden" id="eHr"><input type="hidden" id="eKm"><input type="hidden" id="freeKm">
  <!-- Buttons -->
  <div class="btn-group">
    <button onclick="saveTrip()">üíæ Save</button>
    <button onclick="showTrips()">üìë View All</button>
    <button onclick="shareLast()">üì§ WhatsApp</button>
    <button onclick="exportPDF()">üìÑ Export PDF</button>
  </div>
  <button style="margin-top:15px;" onclick="openRates()">‚úèÔ∏è Edit Rates</button>
</div>

<!-- View All Trips Popup -->
<div class="popup" id="tripPopup">
  <h3>üìã All Trips</h3>
  <div class="btn-group">
    <button onclick="exportToExcel()">üì• Export Excel</button>
    <button onclick="tripPopup.style.display='none'">Close</button>
  </div>
  <div id="tripList"></div>
</div>

<!-- Rate Editor -->
<div class="ratePopup" id="ratePopup">
  <h3>‚úèÔ∏è Edit Vehicle Rates</h3>
  <table>
    <thead><tr><th>Model</th><th>Package ‚Çπ</th><th>Extra Hr ‚Çπ</th><th>Extra KM ‚Çπ</th><th>Free KM</th></tr></thead>
    <tbody id="rateRows"></tbody>
  </table>
  <button onclick="saveRates()">Save Rates</button>
  <button onclick="ratePopup.style.display='none'">Cancel</button>
</div>

<!-- Print Container -->
<div id="printContent"></div>

<!-- Script Logic -->
<script>
// Full JavaScript: Too large to paste here again, but you already have the full script in your version above.
// Simply insert the complete script from your current app which includes:
// - sync()
// - recalc()
// - genId()
// - saveTrip()
// - clearForm()
// - showTrips()
// - editTrip()
// - deleteTrip()
// - shareTrip()
// - shareLast()
// - openRates()
// - saveRates()
// - exportPDF()

// ADD THIS to your script for Excel:
function exportToExcel() {
  const trips = JSON.parse(localStorage.getItem('nst-trips') || '[]');
  if (!trips.length) return alert("No trips to export.");
  const data = trips.map(t => ({
    "Trip ID": t.id, "Date": formatDate(t.date), "Customer Name": t.cust,
    "Customer Number": t.custNum, "Driver Name": t.driver, "Driver Number": t.driverNum,
    "Vehicle Model": t.model, "Vehicle Number": t.no,
    "Start Time": to12Hr(t.start), "End Time": to12Hr(t.end),
    "Duration (hrs)": t.duration, "Extra Hours": t.extraHr,
    "Start KM": t.startKM, "End KM": t.endKM,
    "Total KM": t.totalKM, "Extra KM": t.extraKM,
    "Package ‚Çπ": t.pkg, "Extra Hr ‚Çπ": t.hrCost, "Extra KM ‚Çπ": t.kmCost,
    "Toll ‚Çπ": t.toll, "Parking ‚Çπ": t.park, "Total ‚Çπ": t.total,
    "Note": t.note || "-"
  }));
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "NST Trips");
  XLSX.writeFile(wb, "NST_Trip_Records.xlsx");
}
tripId.value = genId();
</script>

</body>
</html>
